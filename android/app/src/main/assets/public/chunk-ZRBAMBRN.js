import{A as P,B as J,I as L,f as T,h as x,l as w,n as Q,p as k,q as M,r as b,s as $,t as u,u as U,w as q,x as z,y as F,z as v}from"./chunk-7O27EJNM.js";import{j as m,k as y,l as A,m as j,p as D,s as O,v as R}from"./chunk-YFH255HC.js";import{a as g,b as f,i as I}from"./chunk-6SXTDW4T.js";var se=(()=>{let C=class C{constructor(e,s,t){this.firestore=e,this.auth=s,this.authPushService=t,this.authState$=x(this.auth),console.log("ChatService initialized"),this.authState$=x(this.auth),this.authPushService.newMessageReceived.subscribe(r=>{console.log("New message received:",r)})}getAuthState(){return this.authState$}generateChatId(e,s){let t=[e,s].sort();return`${t[0]}_${t[1]}`}getOrCreateChat(e){return I(this,null,function*(){let s=this.auth.currentUser;if(!s)throw new Error("No user logged in");let t=s.uid,r=this.generateChatId(t,e),c=u(this.firestore,"chats",r),n=yield U(c);if(n.exists()){if(console.log(`Chat ${r} already exists.`),!n.data().participantNames){let d=s.displayName||"Anonymous",i=yield U(u(this.firestore,"users",e)),p=i.exists()&&i.data().displayName||"Unknown User";yield P(c,{participantNames:{[t]:d,[e]:p}}),console.log("Added participant names to existing chat.")}}else{console.log(`Chat ${r} does not exist, creating...`);let a=s.displayName||"Anonymous",d=yield U(u(this.firestore,"users",e)),i=d.exists()&&d.data().displayName||"Unknown User",p={participantIds:[t,e].sort(),participants:{[t]:!0,[e]:!0},participantNames:{[t]:a,[e]:i},createdAt:w.now(),lastMessage:"",lastMessageTimestamp:w.now()};yield v(c,p),console.log(`Chat ${r} created with participant names.`)}return r})}getUserNameById(e){if(!e)return m(null);let s=u(this.firestore,`users/${e}`);return M(s).pipe(y(t=>(console.log(`Fetched user data for ${e}:`,t),t&&(t.displayName||t.name||t.fullName)||"Unknown User")))}getChatMessages(e,s=50){if(!e)return console.error("Cannot get messages: Chat ID is missing"),m([]);let t=u(this.firestore,"chats",e),r=$(t,"messages"),c=F(r,z("timestamp","desc"),q(s));return k(c,{idField:"id"}).pipe(D(n=>{let a=n;return a.length===0?m([]):M(t).pipe(D(d=>{let i=d,p=this.auth.currentUser,l=i.participantIds.length===1||i.participantIds.length===2&&i.participantIds[0]===i.participantIds[1]||p&&i.participantIds.filter(o=>o===p.uid).length===i.participantIds.length,h=a.map(o=>o.senderId?this.getUserNameById(o.senderId).pipe(y(N=>l&&p&&o.senderId===p.uid?f(g({},o),{senderNameFromDB:`${N||o.senderName||"You"} (You)`}):f(g({},o),{senderNameFromDB:N||o.senderName||"Unknown User"}))):m(f(g({},o),{senderNameFromDB:"Unknown User"})));return A(h).pipe(y(o=>o.sort((N,E)=>{var B,Y;let W=(B=N.timestamp)!=null&&B.toMillis?N.timestamp.toMillis():0,G=(Y=E.timestamp)!=null&&Y.toMillis?E.timestamp.toMillis():0;return W-G})))}))}))}sendMessage(e,s){return I(this,null,function*(){let t=this.auth.currentUser;if(!t)throw new Error("Cannot send message: No user logged in");if(!e)throw new Error("Cannot send message: Chat ID is missing");let r=u(this.firestore,"chats",e),c=$(r,"messages"),n=u(this.firestore,"users",t.uid),a=yield U(n),d=a.exists()?a.data().displayName||t.displayName||"Anonymous":t.displayName||"Anonymous",i={text:s,timestamp:w.now(),senderId:t.uid,senderName:d,type:"text"};try{yield b(c,i),console.log(`Message sent to chat ${e}`),yield P(r,{lastMessage:s,lastMessageTimestamp:w.now()}),console.log("Chat document updated with last message")}catch(p){throw console.error("Error sending message:",p),p}})}sendImageMessage(e,s){return I(this,null,function*(){let t=this.auth.currentUser;if(!t)throw new Error("Cannot send image: No user logged in");if(!e)throw new Error("Cannot send image: Chat ID is missing");let r=u(this.firestore,"chats",e),c=$(r,"messages"),n=u(this.firestore,"users",t.uid),a=yield U(n),d=a.exists()?a.data().displayName||t.displayName||"Anonymous":t.displayName||"Anonymous",i={timestamp:w.now(),senderId:t.uid,senderName:d,type:"image",imageData:s};try{yield b(c,i),console.log(`Image message sent to chat ${e}`),yield P(r,{lastMessage:"\u{1F4F7} Photo",lastMessageTimestamp:w.now()}),console.log("Chat document updated with last message")}catch(p){throw console.error("Error sending image message:",p),p}})}createSelfChat(){return I(this,null,function*(){let e=this.auth.currentUser;if(!e)throw new Error("No user logged in");let s=this.generateChatId(e.uid,e.uid),t=u(this.firestore,"chats",s);if(!(yield U(t)).exists()){console.log(`Self-chat ${s} does not exist, creating...`);let c=e.displayName||"You",n={participantIds:[e.uid],participants:{[e.uid]:!0},participantNames:{[e.uid]:c},createdAt:w.now(),lastMessage:"",lastMessageTimestamp:w.now()};yield v(t,n),console.log(`Self-chat ${s} created.`)}return s})}debugUserData(){return I(this,null,function*(){let e=this.auth.currentUser;if(!e)return;console.log("Auth User:",{uid:e.uid,displayName:e.displayName});let s=yield U(u(this.firestore,"users",e.uid));console.log("Firestore User:",s.exists()?s.data():"No document")})}getUserChats(){return this.authState$.pipe(D(e=>{if(!e)return console.warn("User not logged in, returning empty chats."),m([]);console.log("Fetching chats for user:",e.uid);let s=$(this.firestore,"chats"),t=F(s,J("participantIds","array-contains",e.uid));return k(t,{idField:"id"}).pipe(D(r=>{let c=r;if(c.length===0)return m([]);let n=c.map(a=>{if(a.participantIds.length===1||a.participantIds.length===2&&a.participantIds[0]===a.participantIds[1]){let l=u(this.firestore,"users",e.uid);return M(l).pipe(y(h=>{let o=h?h.displayName||h.name||h.fullName||e.displayName||"You":e.displayName||"You",N=h&&h.profilePicture||"";return f(g({},a),{otherParticipantId:e.uid,otherParticipantName:`${o} (You)`,otherParticipantProfilePicture:N})}))}let i=a.participantIds.find(l=>l!==e.uid);if(!i)return console.warn(`No other participant found in chat ${a.id}`),m(f(g({},a),{otherParticipantId:"",otherParticipantName:"Unknown User"}));let p=u(this.firestore,"users",i);return M(p).pipe(y(l=>{console.log(`User data for ${i}:`,l);let h="Unknown User",o="";return l&&(h=l.displayName||l.name||l.fullName||"Unknown User",o=l.profilePicture||""),console.log(`Name for user ${i}: ${h}`),f(g({},a),{otherParticipantId:i,otherParticipantName:h,otherParticipantProfilePicture:o})}))});return A(n)}))}))}markMessageAsRead(e,s){let t=u(this.firestore,"chats",e,"messages",s);return P(t,{isRead:!0})}isSenderInChat(e,s){return!0}getChatWithDetails(e){let s=u(this.firestore,"chats",e);return M(s,{idField:"id"}).pipe(D(t=>{if(!t)return m(null);let r=t;if(!r.participantIds||!Array.isArray(r.participantIds)||r.participantIds.length===0)return m(f(g({},r),{participants:{}}));let c=r.participantIds.map(n=>this.getUserNameById(n).pipe(y(a=>({uid:n,name:a}))));return j(c).pipe(y(n=>{let a={};return n.forEach(d=>{d&&d.uid&&(a[d.uid]={name:d.name})}),f(g({},r),{participants:a})}))}))}};C.\u0275fac=function(s){return new(s||C)(R(Q),R(T),R(L))},C.\u0275prov=O({token:C,factory:C.\u0275fac,providedIn:"root"});let S=C;return S})();export{se as a};
